{% extends 'core/base.html' %}

{% block title %}{% if existing_rating %}Editar{% else %}Agregar{% endif %} Calificación{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-2xl">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'item:detail' item.id %}" class="text-purple-600 hover:text-purple-800 font-medium mb-4 inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Volver al producto
        </a>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            {% if existing_rating %}
                <i class="fas fa-edit text-purple-600 mr-2"></i>Editar Calificación
            {% else %}
                <i class="fas fa-star text-yellow-500 mr-2"></i>Calificar Producto
            {% endif %}
        </h1>
        <p class="text-gray-600">{{ item.name }}</p>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-2xl shadow-lg p-8">
        <form method="post" action="." id="rating-form">
            {% csrf_token %}
            
            <!-- Calificación con estrellas -->
            <div class="mb-6">
                <label class="block text-lg font-semibold text-gray-900 mb-4">
                    Calificación <span class="text-red-500">*</span>
                </label>
                
                <div class="flex items-center space-x-2 mb-2">
                    {% for value, label in form.fields.rating.choices %}
                        <label class="cursor-pointer group">
                            <input 
                                type="radio" 
                                name="rating" 
                                value="{{ value }}" 
                                class="hidden rating-input"
                                {% if existing_rating and existing_rating.rating == value %}checked{% endif %}
                                required
                            >
                            <i class="fas fa-star text-4xl transition-colors duration-200 
                                {% if existing_rating and existing_rating.rating >= value %}
                                    text-yellow-400
                                {% else %}
                                    text-gray-300 group-hover:text-yellow-300
                                {% endif %}"
                                data-value="{{ value }}"></i>
                        </label>
                    {% endfor %}
                </div>
                
                <p class="text-sm text-gray-500 mt-2" id="rating-text">
                    {% if existing_rating %}
                        {{ existing_rating.get_rating_display }}
                    {% else %}
                        Selecciona una calificación
                    {% endif %}
                </p>
            </div>

            <!-- Reseña -->
            <div class="mb-6">
                <label class="block text-lg font-semibold text-gray-900 mb-2">
                    Reseña <span class="text-gray-400 text-sm font-normal">(Opcional)</span>
                </label>
                {{ form.review }}
                <p class="text-sm text-gray-500 mt-2">
                    Comparte tu experiencia con este producto
                </p>
            </div>

            <!-- Botones -->
            <div class="flex space-x-4">
                <button 
                    type="submit" 
                    class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg"
                >
                    <i class="fas fa-check mr-2"></i>
                    {% if existing_rating %}Actualizar{% else %}Publicar{% endif %} Calificación
                </button>
                
                <a 
                    href="{% url 'item:detail' item.id %}" 
                    class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200"
                >
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<style>
    .rating-input:checked ~ i,
    .rating-input:checked ~ i ~ i {
        color: #fbbf24 !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ratingInputs = document.querySelectorAll('.rating-input');
    const stars = document.querySelectorAll('[data-value]');
    const ratingText = document.getElementById('rating-text');
    
    const ratingLabels = {
        1: '1 - Muy malo',
        2: '2 - Malo',
        3: '3 - Regular',
        4: '4 - Bueno',
        5: '5 - Excelente'
    };
    
    // Hover effect
    stars.forEach(star => {
        star.addEventListener('mouseenter', function() {
            const value = parseInt(this.dataset.value);
            highlightStars(value);
        });
        
        star.addEventListener('click', function() {
            const value = parseInt(this.dataset.value);
            const input = this.parentElement.querySelector('input');
            input.checked = true;
            ratingText.textContent = ratingLabels[value];
            highlightStars(value);
        });
    });
    
    // Reset on mouse leave
    const container = document.querySelector('.flex.items-center.space-x-2');
    container.addEventListener('mouseleave', function() {
        const checkedInput = document.querySelector('.rating-input:checked');
        if (checkedInput) {
            const value = parseInt(checkedInput.value);
            highlightStars(value);
        } else {
            resetStars();
        }
    });
    
    function highlightStars(value) {
        stars.forEach(star => {
            const starValue = parseInt(star.dataset.value);
            if (starValue <= value) {
                star.classList.remove('text-gray-300');
                star.classList.add('text-yellow-400');
            } else {
                star.classList.remove('text-yellow-400');
                star.classList.add('text-gray-300');
            }
        });
    }
    
    function resetStars() {
        stars.forEach(star => {
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
        });
    }
});
</script>
{% endblock %}
